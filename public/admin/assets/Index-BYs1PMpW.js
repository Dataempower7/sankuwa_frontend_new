import{d as Te,r as l,b as We,o as Ne,f as L,g as i,h as a,i as e,z as d,k as J,l as b,L as H,al as $e,O as Y,m as w,j as y,am as de,q as ve,Q as ue,t as c,F as T,p as O,n as B,ah as he,P as W,an as Fe,s as Re,ao as Ae,ap as He,_ as Oe}from"./index-B52YIGC0.js";import{c as V,_ as D}from"./format-BxqOrW-w.js";import Be from"./Message-DczNoDJ9.js";import{d as Ve,g as _e}from"./SendMessage-4Jk2ijgH.js";import De from"./CurrentQueueNumber-BOhvt1v_.js";import{g as Pe,s as Qe,a as Ue}from"./conversation-BgR-gwnn.js";import"./Verify.vue_vue_type_style_index_0_lang-BAuPCCIW.js";import"./zh-cn-kq_pLf4V.js";import{_ as j}from"./QueueList-CCKVDITl.js";import{u as qe}from"./im-DspQDQGM.js";import Ge from"./promptTone-Bi1NJCjO.js";import"./Reconnection-EqLGNFmK.js";import"./ReconnectionList-C2nCEauX.js";import"./StatusDot-DuKP0Xmc.js";/* empty css             *//* empty css                                                                    */import"./Pagination-C8J7-6Em.js";import"./product-hE35r0Q_.js";import"./OrderImList-D13-nqzT.js";import"./order-BVunCi_y.js";import"./index-KjhYqCTY.js";import"./index-C9ZdVeVx.js";import"./DialogForm.vue_vue_type_script_setup_true_lang-CT6mpwCc.js";import"./Emoji-D1NIuMzg.js";import"./DeleteRecord-BTXBpwL2.js";import"./brand-CyfpB5Ly.js";const N=class N{log(o,g){N.console}closeConsole(){N.console=!1}};N.console=!0;let K=N;class Je extends K{constructor(){super(...arguments),this.listeners={}}addEventListener(o,g){this.listeners[o]||(this.listeners[o]=[]),this.listeners[o].indexOf(g)===-1&&this.listeners[o].push(g)}removeEventListener(o){this.listeners[o]=[]}dispatchEvent(o,g){const x=this.listeners[o]||[];x.length!==0&&x.forEach(u=>{u.call(this,g)})}}class Ye extends Je{constructor(o){super(),this.url="",this.socket=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectInterval=1e3,this.heartbeatInterval=1e3*15,this.stopWs=!1,this.url=o}onopen(o){this.addEventListener("open",o)}onmessage(o){this.addEventListener("message",o)}onclose(o){this.addEventListener("close",o)}onerror(o){this.addEventListener("error",o)}send(o){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(o):console.error("[WebSocket] 未连接")}connect(){this.reconnectAttempts===0&&this.log("WebSocket",`初始化连接中...          ${this.url}`),!(this.socket&&this.socket.readyState===WebSocket.OPEN)&&(this.socket=new WebSocket(this.url),this.socket.onopen=o=>{this.stopWs=!1,this.reconnectAttempts=0,this.startHeartbeat(),this.log("WebSocket",`连接成功,等待服务端数据推送[onopen]...     ${this.url}`),this.dispatchEvent("open",o)},this.socket.onmessage=o=>{this.dispatchEvent("message",o),this.startHeartbeat()},this.socket.onclose=o=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接断开[onclose]...    ${this.url}`),this.stopWs||this.handleReconnect(),this.dispatchEvent("close",o)},this.socket.onerror=o=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接异常[onerror]...    ${this.url}`),this.closeHeartbeat(),this.dispatchEvent("error",o)})}handleReconnect(){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,this.log("WebSocket",`尝试重连... (${this.reconnectAttempts}/${this.maxReconnectAttempts})       ${this.url}`),setTimeout(()=>{this.connect()},this.reconnectInterval)):(this.closeHeartbeat(),this.log("WebSocket",`最大重连失败，终止重连: ${this.url}`))}close(){this.socket&&(this.stopWs=!0,this.socket.close(),this.socket=null,this.removeEventListener("open"),this.removeEventListener("message"),this.removeEventListener("close"),this.removeEventListener("error")),this.closeHeartbeat()}startHeartbeat(){this.stopWs||(this.heartbeatTimer&&this.closeHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.socket?(this.socket.send(JSON.stringify({type:"heartBeat",data:{}})),this.log("WebSocket","送心跳数据...")):console.error("[WebSocket] 未连接")},this.heartbeatInterval))}closeHeartbeat(){clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0}}const je={class:"app-layout-m_content_wYOV9"},Ke={class:"im"},Xe={class:"im-resizable im-left reception-panel im-resizable-right"},Ze={class:"reception-panel-search"},et={class:"super-search-box-module_wrap_i3xn3 reception-panel-search-searcher"},tt={class:"super-search-box-module_search_2qwmN"},st={class:"super-search-box-module_icon_1LUOA"},nt={class:"conversation-list-item-del"},at={class:"reception-panel-mask"},ot={class:"reception-filter-content"},it={key:0,class:"reception-filter-list"},rt={class:"reception-filter-item-title"},ct=["onClick"],lt={class:"reception-filter-item-head"},dt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},vt=["src"],ut={key:1,class:"zent-avatar-image",src:D},ht={class:"reception-filter-item-body"},_t={class:"reception-filter-item-name"},mt={class:"name"},pt={class:"label text-transform"},gt={key:1,class:"reception-filter-list"},ft={class:"reception-filter-item-title"},bt=["onClick"],yt={class:"reception-filter-item-head"},kt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},zt=["src"],Ct={key:1,class:"zent-avatar-image",src:D},wt={class:"reception-filter-item-body"},xt={class:"reception-filter-item-name"},St={class:"name"},It={class:"label text-transform"},Mt={class:"reception-filter-item-desc"},Et={class:"desc"},Lt={class:"time"},Tt={class:"reception-panel-wrap"},Wt={class:"zent-tabs zent-tabs-type__normal reception-panel-tabs Panel-m_reception-panel-tabs_82Sn7"},Nt={class:"zent-tabs-nav zent-tabs-nav-type__normal zent-tabs-nav__stretch"},$t={class:"zent-tabs-nav-content"},Ft={class:"zent-tabs-scroll",role:"tablist"},Rt={class:"zent-tabs-tab-inner"},At={class:"zent-tabs-tab-inner"},Ht={class:"reception-panel-toolbar"},Ot={class:"flex flex-justify-between"},Bt={class:"reception-panel-toolbar-waiting-count"},Vt={class:"collapse-m_wrap_H4xuY reception-panel-ongoing"},Dt={class:"conversation-list"},Pt={key:0,style:{position:"relative",width:"280px",overflow:"auto","will-change":"transform",direction:"ltr"}},Qt=["onClick"],Ut={class:"conversation-list-item-mark"},qt={class:"zent-tooltip-wrapper"},Gt={class:""},Jt={class:"conversation-list-item-del"},Yt={class:"zent-badge zent-badge--has-content conversation-list-item-avatar"},jt={class:"zent-badge-content"},Kt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},Xt=["src"],Zt={key:1,class:"zent-avatar-image",src:D},es={key:0,class:"zent-badge-count"},ts={class:"conversation-list-item-content"},ss={class:"conversation-list-item-line"},ns={class:"conversation-list-item-name"},as={class:"conversation-list-item-tag"},os={class:"zent-tag zent-tag-style-grey-outline conversation-list-item-tag-default zent-tag-rounded"},is={class:"zent-tag-content text-transform"},rs={class:"conversation-list-item-line"},cs={key:0,class:"conversation-list-item-message"},ls={key:0},ds=["innerHTML"],vs={key:1},us={class:"conversation-list-item-timestamp"},hs={key:1,class:"collapse-m_wrap_H4xuY reception-panel-ongoing"},_s={class:"conversation-list reception-panel-finished-list"},ms={key:0,style:{position:"relative",width:"280px",overflow:"auto","will-change":"transform",direction:"ltr"}},ps=["onClick"],gs={class:"conversation-list-item-mark"},fs={class:"zent-tooltip-wrapper"},bs={class:"zent-badge zent-badge--has-content conversation-list-item-avatar"},ys={class:"zent-badge-content"},ks={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},zs=["src"],Cs={key:1,class:"zent-avatar-image",src:D},ws={key:0,class:"zent-badge-count"},xs={class:"conversation-list-item-content"},Ss={class:"conversation-list-item-line"},Is={class:"conversation-list-item-name"},Ms={class:"conversation-list-item-tag"},Es={class:"zent-tag zent-tag-style-grey-outline conversation-list-item-tag-default zent-tag-rounded"},Ls={class:"zent-tag-content text-transform"},Ts={class:"conversation-list-item-line"},Ws={key:0,class:"conversation-list-item-message"},Ns={class:"conversation-list-item-timestamp"},$s=Te({__name:"Index",emits:["update:isEditComment","successAdded","sendMessage"],setup(X,{emit:o}){const g=l(),x=l(),u=l(-1),z=l(1),P=l(!1),$=l(!1),F=t=>{z.value=t,t===1&&(I("tab"),P.value=!1),t===2&&(q("tab"),$.value=!1)},f=l(""),R=l(!1),Q=l(null),h=l({conversationList:[],userList:[]}),me=()=>{R.value=!0},pe=()=>{f.value==""&&h.value.conversationList.length==0&&h.value.userList.length==0&&(R.value=!1)},ge=()=>{f.value="",h.value={conversationList:[],userList:[]},Q.value.focus()},fe=async t=>{if(Q.value.focus(),f.value!="")try{const s=await Pe({keyword:f.value});h.value=s,console.log(h.value)}catch(s){W.error(s.message)}finally{}},Z=l({}),C=l({}),S=(t,s)=>{var r;t!=-1?(C.value=t,u.value=t.id,t.unreadMessageCount>0&&(t.unreadMessageCount=0,(r=g.value)==null||r._setRead(t))):u.value=-1},be=async t=>{console.log(t),Fe.confirm("确认删除该会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{Ve({conversationId:t.id}).then(s=>{C.value="",u.value=-1,I()}).catch(s=>{W.error(s.message)})})},ye=t=>{t&&(C.value.status=1,F(2),F(1))},v=l([]),U=l([]),k=l(!1),I=async t=>{try{k.value=!0,console.log("====");const s=await _e({status:1});v.value=s.records,t!=="tab"&&s.records.forEach(r=>{Number(r.unreadMessageCount)>0&&(P.value=!0)})}catch(s){W.error(s.message)}finally{k.value=!1}},q=async t=>{try{k.value=!0;const s=await _e({status:2});U.value=s.records,console.log($.value),t!=="tab"&&s.records.forEach(r=>{Number(r.unreadMessageCount)>0&&($.value=!0)})}catch(s){W.error(s.message)}finally{k.value=!1}},ke=async()=>{await I(),await q()},ze=t=>{},Ce=t=>{var r;const s=v.value.findIndex(A=>A.id===t.conversationId);u.value>-1?(t.conversationId===u.value?(Z.value=t,t.content.contentCategory==="end_conversation"&&(C.value.status=2)):s===-1&&ee(t),v.value[s].lastMessage[0]=t,v.value[s].unreadMessageCount++):s>-1?(v.value[s].lastMessage[0]=t,v.value[s].unreadMessageCount++):ee(t),t.content.contentCategory==="end_conversation"&&(v.value[s].status=2),(r=x.value)==null||r.play()},ee=t=>{const s={id:t.conversationId,shopId:t.shopId,userId:t.userId,lastMessage:[t],unreadMessageCount:1,user:t.user,userFrom:t.userFrom};v.value=[s,...v.value]},we=t=>{var r;if(!Ae(t.data)){console.error("收到非JSON格式数据");return}const s=JSON.parse(t.data);s.type==="message"&&s.data&&Ce(s.data[0]),s.type==="read"&&s.data[0].shopId===C.value.shopId&&((r=g.value)==null||r.setReadOneself())},xe=t=>{},Se=t=>{},Ie=()=>{let t;return t=location.origin?location.origin.replace(/^http:/,"ws:").replace(/^https:/,"wss:")+"/ws":"",t};(()=>{const t=new Ye(`${Ie()}?token=${localStorage.getItem("accessToken")}&platform=admin`);t.onclose(xe),t.onopen(ze),t.onerror(Se),t.onmessage(we),t.connect()})();const G=l(0),te=l(null),Me=async()=>{try{const t=qe(),s=await Qe({status:1});t.setImPresence(1);const r=await Ue({page:1});G.value=r.total,G.value>0&&Re(()=>{te.value.showWin()})}catch(t){W.error(t.message)}finally{}};He("receiveValueFromGrandChild",t=>{console.log("receiveValueFromGrandChild",t),v.value.map(s=>{s.id===t.conversationId&&(s.lastMessage=[t])})});const se=We().currentRoute.value.query;return Ne(async()=>{if(await Me(),await I(),await q(),se.id){const t=v.value.find(s=>s.id===parseInt(se.id));t&&await S(t)}}),(t,s)=>{var oe,ie;const r=L("SvgIcon"),A=L("el-icon"),Ee=L("el-button"),ne=L("el-badge"),ae=L("a-spin");return a(),i("div",je,[e("div",Ke,[e("div",Xe,[e("div",Ze,[e("div",et,[e("div",tt,[e("span",st,[d(r,{name:"im-search",width:"16",height:"16"})]),H(e("input",{ref_key:"searchInput",ref:Q,"onUpdate:modelValue":s[0]||(s[0]=n=>f.value=n),onFocus:me,onBlur:pe,class:"super-search-box-module_input_3HdzN",placeholder:"搜索最近联系人、聊天记录"},null,544),[[$e,f.value]]),H(e("div",nt,[d(A,{onClick:ve(ge,["stop","prevent"]),size:"13",color:"#797979"},{default:w(()=>[d(y(de))]),_:1})],512),[[Y,f.value!=""]])]),H(d(Ee,{class:"super-search-btn",type:"primary",size:"mini",onClick:fe},{default:w(()=>[...s[4]||(s[4]=[ue("搜索",-1)])]),_:1},512),[[Y,R.value&&f.value!=""]])])]),H(e("div",at,[e("div",ot,[h.value.userList.length>0?(a(),i("div",it,[e("div",rt,"联系人("+c(((oe=h.value.userList)==null?void 0:oe.length)||0)+")",1),(a(!0),i(T,null,O(h.value.userList,(n,M)=>{var _,m,p;return a(),i("div",{class:"reception-filter-item cursor-pointer",key:M,onClick:E=>S(n)},[e("div",lt,[e("span",dt,[(_=n.user)!=null&&_.avatar?(a(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,vt)):(a(),i("img",ut))])]),e("div",ht,[e("div",_t,[e("div",mt,c((p=n.user)==null?void 0:p.username),1),e("div",pt,c(n.userFrom),1)])])],8,ct)}),128))])):b("",!0),h.value.conversationList.length>0?(a(),i("div",gt,[e("div",ft,"聊天记录("+c(((ie=h.value.conversationList)==null?void 0:ie.length)||0)+")",1),(a(!0),i(T,null,O(h.value.conversationList,(n,M)=>{var _,m,p;return a(),i("div",{class:"reception-filter-item cursor-pointer",key:M,onClick:E=>S(n)},[e("div",yt,[e("span",kt,[(_=n.user)!=null&&_.avatar?(a(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,zt)):(a(),i("img",Ct))])]),e("div",wt,[e("div",xt,[e("div",St,c((p=n.user)==null?void 0:p.username),1),e("div",It,c(n.userFrom),1)]),e("div",Mt,[e("div",Et,c(f.value),1),e("div",Lt,[d(y(j),{time:n.addTime},null,8,["time"])])])])],8,bt)}),128))])):b("",!0)])],512),[[Y,R.value]]),e("div",Tt,[e("div",Wt,[e("div",Nt,[e("div",$t,[e("div",Ft,[e("div",{class:B(["zent-tabs-tab zent-tabs-tab-type__normal",{"zent-tabs-tab__actived":z.value===1}]),onClick:s[1]||(s[1]=n=>F(1))},[d(ne,{"is-dot":"",offset:[-80,15],color:P.value?"#f33":"#fff"},{default:w(()=>[e("div",Rt,"会话中("+c(v.value.length)+")",1)]),_:1},8,["color"])],2),e("div",{class:B(["zent-tabs-tab zent-tabs-tab-type__normal",{"zent-tabs-tab__actived":z.value===2}]),onClick:s[2]||(s[2]=n=>F(2))},[d(ne,{"is-dot":"",offset:[-80,15],color:$.value?"#f33":"#fff"},{default:w(()=>[e("div",At,"已结束("+c(U.value.length)+")",1)]),_:1},8,["color"])],2)])])])]),z.value===1?(a(),i(T,{key:0},[e("div",Ht,[d(De,{ref_key:"CurrentQueueNumbererRef",ref:te,onClose:ke,style:{width:"100%"}},{default:w(()=>[e("div",Ot,[e("div",null,[s[5]||(s[5]=ue(" 待接入数量：",-1)),e("span",Bt,c(G.value),1)]),d(r,{class:"zenticon zenticon-right",name:"im-arrow",width:"12",height:"12"})])]),_:1},512)]),e("div",Vt,[e("div",{class:"collapse-m_panel_2ePsT",style:he([{"flex-basis":"40px"},"flex-grow: 6"])},[e("div",Dt,[k.value?(a(),J(ae,{key:1,spinning:k.value,style:{width:"100%","margin-top":"100px",height:"200px"}},null,8,["spinning"])):(a(),i("div",Pt,[(a(!0),i(T,null,O(v.value,(n,M)=>{var _,m,p,E,re,ce,le;return a(),i("div",{class:B(["conversation-list-item",{"conversation-list-item-active":u.value==n.id}]),onClick:Le=>S(n)},[e("div",Ut,[e("div",qt,[d(r,{class:"zenticon zenticon-star conversation-list-item-mark-star",name:"im-markstar",width:"10",height:"10"})])]),e("div",Gt,[e("div",Jt,[d(A,{onClick:ve(Le=>be(n),["stop","prevent"]),size:"20",color:"#bbbbbb"},{default:w(()=>[d(y(de))]),_:1},8,["onClick"])])]),e("div",Yt,[e("div",jt,[e("span",Kt,[(_=n.user)!=null&&_.avatar?(a(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,Xt)):(a(),i("img",Zt))]),n.unreadMessageCount>0?(a(),i("span",es,c(n.unreadMessageCount),1)):b("",!0)])]),e("div",ts,[e("div",ss,[e("div",ns,c(n.user?n.user.username:""),1),e("div",as,[e("div",os,[e("div",is,c(n.userFrom),1)])])]),e("div",rs,[n.lastMessage?(a(),i("div",cs,[((p=n.lastMessage[0])==null?void 0:p.messageType)=="text"?(a(),i("div",ls,[e("div",{class:"conversation-list-item-message-text",innerHTML:(re=(E=n.lastMessage[0])==null?void 0:E.content)==null?void 0:re.content},null,8,ds)])):(a(),i("div",vs,c((ce=n.lastMessage[0])==null?void 0:ce.messageTypeText),1))])):b("",!0),e("div",us,[d(y(j),{time:(le=n.lastMessage[0])==null?void 0:le.sendTime},null,8,["time"])])])])],10,Qt)}),256))]))])])])],64)):b("",!0),z.value===2?(a(),i("div",hs,[e("div",{class:"collapse-m_panel_2ePsT",style:he([{"flex-basis":"40px"},"flex-grow: 6"])},[e("div",_s,[k.value?(a(),J(ae,{key:1,spinning:k.value,style:{width:"100%","margin-top":"100px",height:"200px"}},null,8,["spinning"])):(a(),i("div",ms,[(a(!0),i(T,null,O(U.value,(n,M)=>{var _,m,p;return a(),i("div",{class:B(["conversation-list-item",{"conversation-list-item-active":u.value==n.id}]),onClick:E=>S(n,z.value)},[e("div",gs,[e("div",fs,[d(r,{class:"zenticon zenticon-star conversation-list-item-mark-star",name:"im-markstar",width:"10",height:"10"})])]),e("div",bs,[e("div",ys,[e("span",ks,[(_=n.user)!=null&&_.avatar?(a(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,zs)):(a(),i("img",Cs))]),n.unreadMessageCount>0?(a(),i("span",ws,c(n.unreadMessageCount),1)):b("",!0)])]),e("div",xs,[e("div",Ss,[e("div",Is,c(n.user?n.user.username:""),1),e("div",Ms,[e("div",Es,[e("div",Ls,c(n.userFrom),1)])])]),e("div",Ts,[n.lastMessage?(a(),i("div",Ws,c(((p=n.lastMessage[0].content)==null?void 0:p.content)||n.lastMessage[0].messageTypeText),1)):b("",!0),e("div",Ns,[d(y(j),{time:n.addTime},null,8,["time"])])])])],10,ps)}),256))]))])])])):b("",!0)])]),s[6]||(s[6]=e("div",{class:"im-resizable-anchor"},null,-1)),u.value?(a(),J(Be,{key:0,ref_key:"ImMessageRef",ref:g,conversationId:u.value,"onUpdate:conversationId":s[3]||(s[3]=n=>u.value=n),currentNewMessage:Z.value,currentConversationData:C.value,msgType:z.value,onResumeConversation:ye,on_getConversationStrat:I},null,8,["conversationId","currentNewMessage","currentConversationData","msgType"])):b("",!0)]),d(Ge,{ref_key:"promptToneRef",ref:x},null,512)])}}}),dn=Oe($s,[["__scopeId","data-v-9c2a5a34"]]);export{dn as default};

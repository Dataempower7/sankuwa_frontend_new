import{d as fe,aq as z,r as V,b as Ne,ab as Pe,ar as ye,c as A,o as _e,P as B,as as be,f as P,g as S,h as f,i as m,k as D,l as k,m as u,z as a,t as T,Q as h,F as M,p as F,j as Q,av as De,_ as ke}from"./index-B52YIGC0.js";/* empty css                                                                  */import{_ as Ve}from"./Checkbox.vue_vue_type_script_setup_true_lang-CA619vaZ.js";import{_ as H}from"./PriceInput.vue_vue_type_script_setup_true_lang-DpJJvzpB.js";import{j as he,k as we}from"./groupon-BtcEMuW-.js";const xe={class:"container"},Ie={class:"content_wrapper"},Le={class:"lyecs-form-table"},Se={style:{"padding-bottom":"10px"}},Ge={class:"num-box"},Ee=["onClick"],Ue={class:"promotion-table"},Ke={class:"flex flex-align-center"},qe={class:"flex"},$e={class:"extra"},Ce=fe({__name:"Info",props:z({grouponPromotionId:{type:Number,default:0},id:{type:Number,default:0},groupType:{type:Number,default:1},product:{type:Object,default:{}},rowData:{type:Object,default:{}},act:{type:String,default:""},isDialog:{type:Boolean,default:!1}},{isLimit:{type:Boolean,default:!1},isLimitModifiers:{}}),emits:z(["submitCallback","update:confirmLoading","close"],["update:isLimit"]),setup(U,{expose:W,emit:X}){const G=X,d=U,K=V(!0),q=Ne().currentRoute.value.query,$=V(d.isDialog?d.act:String(q.act)),J=V(d.isDialog?d.id:Number(q.id)),N=V(d.isDialog?d.groupType:Number(q.groupType)),_=V(d.product.productSkus||[]),j=Pe(),t=V({grouponPromotionDetails:[]}),w=ye(U,"isLimit"),Y=$.value==="add"?"create":"update",Z=()=>{if(d.product.groupNum)try{l.value=JSON.parse(d.product.groupNum)}catch{l.value=N.value===1?[{groupNumKey:1}]:[{groupNumKey:1},{groupNumKey:2}],l.value=[],console.log("解析阶梯数据失败")}else l.value=N.value===1?[{groupNumKey:1}]:[{groupNumKey:1},{groupNumKey:2}]},l=V([]),E=A(()=>["一","二","三","四","五"].slice(0,l.value.length)),ee=()=>{if(t.value.groupNums=l.value,t.value.grouponPromotionId=d.grouponPromotionId,t.value.productId=d.product.productId,t.value.groupType=N.value,!_.value||!_.value.length){const r={productId:d.product.productId,productPrice:d.product.productPrice,marketPrice:d.product.marketPrice,limitNum:d.product.limitNum,skuId:0,productStock:d.product.productStock,isJoin:1,groupPromotionDetailPrices:[]};l.value.map(e=>{var o;(o=r.groupPromotionDetailPrices)==null||o.push({groupNumKey:e.groupNumKey,price:""})}),t.value.grouponPromotionDetails=[r]}else{const r=[],e={productId:d.product.productId,isJoin:1,groupPromotionDetailPrices:[]};_.value.map(o=>{try{e.productPrice=o.skuPrice,e.marketPrice=o.marketPrice,e.productStock=o.skuStock,e.skuId=o.skuId,e.skuData=o.skuData,e.limitNum=o.limitNum||"",e.groupPromotionDetailPrices=[],o.groupPromotionDetailPrices?e.groupPromotionDetailPrices=o.groupPromotionDetailPrices:l.value.map((n,s)=>{var c;(c=e.groupPromotionDetailPrices)==null||c.push({groupNumKey:n.groupNumKey,price:""})}),r.push({...e})}catch{}}),t.value.grouponPromotionDetails=r}},oe=A(()=>{const r=[],e=new Set;return _.value&&Array.isArray(_.value)&&_.value.forEach(o=>{o.skuData&&o.skuData.forEach(n=>{n.name&&!e.has(n.name)&&(e.add(n.name),r.push(n))})}),r}),re=()=>{if(l.value.length<5){const r=l.value.length>0?Math.max(...l.value.map(e=>e.groupNumKey||0))+1:1;l.value.push({groupNumKey:r}),t.value.groupNums=l.value;for(const e of t.value.grouponPromotionDetails)e.groupPromotionDetailPrices.push({groupNumKey:r,price:""})}},te=r=>{if(r>=2&&l.value.length>2){l.value.splice(r,1),t.value.groupNums=l.value;for(const e of t.value.grouponPromotionDetails)e.groupPromotionDetailPrices.splice(r,1)}},ue=(r,e)=>{try{if(Array.isArray(r)){const o=r.find(n=>n.name===e);return o?o.value:""}}catch(o){console.error("解析skuData失败",o)}return""},le=r=>{r?t.value.orderLimitNum=t.value.orderLimitNum?t.value.orderLimitNum:1:t.value.orderLimitNum=""};_e(()=>{Z(),$.value==="detail"?ae():(ee(),K.value=!1)});const ae=async()=>{try{const r=await he($.value,{grouponPromotionItemId:J.value});Object.assign(t.value,r),_.value=r.productSkus;const e=Number(r.orderLimitNum);if(e&&e>0&&(w.value=!0),t.value.grouponPromotionDetails&&t.value.grouponPromotionDetails)for(const o of r.grouponPromotionDetails)if(o.skuId){const n=_.value.find(s=>s.skuId===o.skuId);n&&(o.productPrice=n.skuPrice,o.productStock=n.skuStock,o.skuData=n.skuData)}else o.productPrice=t.value.productPrice,o.productStock=t.value.productStock}catch(r){console.log(r),B.error(r.message),G("close")}finally{K.value=!1}},O=(r,e,o)=>{const s=r.fullField.match(/grouponPromotionDetails\.(\d+)\.groupPromotionDetailPrices\.(\d+)\.price/);if(s){const c=parseInt(s[1]),v=parseInt(s[2]),g=t.value.grouponPromotionDetails[c];if(g.isJoin!==1){o();return}const b=g.groupPromotionDetailPrices[v].price;if(b===""){o(new Error("拼团价格不能为空"));return}const I=Number(b),C=Number(g.productPrice);if(I>C){o(new Error("拼团价格不能大于商品原价"));return}if(N.value===2&&v>0){const L=Number(g.groupPromotionDetailPrices[v-1].price);if(!isNaN(L)&&L>0&&I>=L){o(new Error(`第${E.value[v]}阶梯价格应低于第${E.value[v-1]}阶梯价格`));return}}}o()},R=(r,e,o)=>{var c;if(N.value===1){if(!((c=l.value[0])!=null&&c.groupNum)){o(new Error("成团人数不能为空"));return}if(l.value[0].groupNum<1){o(new Error("成团人数须大于0"));return}o();return}const s=r.fullField.match(/groupNums\.(\d+)\.groupNum/);if(s){const v=parseInt(s[1]),g=l.value[v];if(!(g!=null&&g.groupNum)){o(new Error("成团人数不能为空"));return}if(g.groupNum<1){o(new Error("成团人数必须大于0"));return}}o()},x=A(()=>{if(N.value===1)return l.value[0].groupNum;const r=l.value.filter(e=>e.groupNum!==void 0&&e.groupNum!==null).map(e=>e.groupNum);return r.length===0?null:Math.min(...r)}),ie=r=>{Number(t.value.minGroupNum)<1&&(t.value.minGroupNum=1),Number(t.value.minGroupNum)>Number(x.value)&&(t.value.minGroupNum=x.value)},ne=(r,e,o)=>{const s=r.fullField.match(/grouponPromotionDetails\.(\d+)\.limitNum/);if(s){const c=parseInt(s[1]),v=t.value.grouponPromotionDetails[c];if(v.isJoin!==1){o();return}v.limitNum||o(new Error("可售数量不能为空"));const g=Number(v.limitNum);let b=Number(v.productStock);if(isNaN(b)&&(b=0),g===0){o(new Error("可售数量不能为0"));return}if(g>b){o(new Error("可售数量不能大于商品库存数量"));return}}o()},se=(r,e,o)=>{if(w.value&&(!t.value.orderLimitNum||t.value.orderLimitNum<1)){o(new Error("限购数量不能为空"));return}o()},pe=(r,e,o)=>{t.value.minGroupNum?(Number(t.value.minGroupNum)<1||Number(t.value.minGroupNum)>Number(x.value))&&o(new Error(`成团最低人数应在1~${x.value}成团人数之间的整数`)):o(new Error("成团最低人数不能为空")),o()},me=be({groupNums:[{required:!0,validator:R,trigger:"blur"}],orderLimitNum:[{required:w,validator:se,trigger:"blur"}]}),de=()=>{var e,o,n;(e=t.value).orderLimitNum??(e.orderLimitNum=0),(o=t.value).isAutoGroup??(o.isAutoGroup=0),(n=t.value).minGroupNum??(n.minGroupNum=0),t.value.groupNums=l.value;const r=[];t.value.grouponPromotionDetails.map(s=>{s.groupPromotionDetailPrices.map(c=>{c.price||(c.price=s.productPrice),c.price&&r.push(Number(c.price))})}),r.length&&(t.value.minGroupPrice=Math.min(...r))},ce=async()=>{await j.value.validate();try{G("update:confirmLoading",!0),de();const r=await we(Y,{id:J.value,...t.value});G("submitCallback",r),B.success("操作成功")}catch(r){B.error(r.message)}finally{G("update:confirmLoading",!1)}};return W({onFormSubmit:()=>{ce()}}),(r,e)=>{const o=P("el-form-item"),n=P("TigInput"),s=P("el-table-column"),c=P("el-icon"),v=P("el-tooltip"),g=P("el-switch"),b=P("el-table"),I=P("el-radio"),C=P("el-radio-group"),L=P("el-form");return f(),S("div",xe,[m("div",Ie,[m("div",Le,[K.value?k("",!0):(f(),D(L,{key:0,ref_key:"formRef",ref:j,rules:me,model:t.value,"label-width":"auto"},{default:u(()=>[a(o,{label:"商品名称"},{default:u(()=>[m("div",null,T(U.product.productName),1)]),_:1}),N.value===1?(f(),D(o,{key:0,class:"inner-item",label:"成团人数",required:"",prop:"groupNums"},{default:u(()=>[m("div",Se,[a(n,{class:"InputBox",modelValue:l.value[0].groupNum,"onUpdate:modelValue":e[0]||(e[0]=i=>l.value[0].groupNum=i),placeholder:"请输入",type:"integer",width:"200px"},{append:u(()=>[...e[6]||(e[6]=[h("人",-1)])]),_:1},8,["modelValue"])])]),_:1})):k("",!0),N.value===2?(f(!0),S(M,{key:1},F(l.value,(i,p)=>(f(),D(o,{key:i.groupNumKey,label:`第${E.value[p]}阶梯`,prop:`groupNums.${p}.groupNum`,class:"groupNums",rules:[{required:!0,validator:R,trigger:"blur"}],style:{"margin-bottom":"14px"}},{default:u(()=>[m("div",Ge,[a(n,{class:"InputBox inputBox-margin",placeholder:"请输入",type:"integer",width:"200px",modelValue:l.value[p].groupNum,"onUpdate:modelValue":y=>l.value[p].groupNum=y},{append:u(()=>[...e[7]||(e[7]=[h("人",-1)])]),_:1},8,["modelValue","onUpdate:modelValue"]),p>=2?(f(),S("a",{key:0,class:"btn-link",onClick:y=>te(p)},"删除",8,Ee)):k("",!0)])]),_:2},1032,["label","prop","rules"]))),128)):k("",!0),N.value===2&&l.value.length<5?(f(),D(o,{key:2,label:" "},{default:u(()=>[m("div",null,[m("a",{class:"btn-link",onClick:re},"添加阶梯"),e[8]||(e[8]=m("div",{class:"desc"},"最多支持添加5个阶梯",-1))])]),_:1})):k("",!0),a(o,{label:"拼团信息"},{default:u(()=>[m("div",Ue,[a(b,{style:{width:"100%"},data:t.value.grouponPromotionDetails},{default:u(()=>[(f(!0),S(M,null,F(oe.value,i=>(f(),D(s,{key:i.name,prop:i.name,label:i.name,align:"center"},{default:u(({row:p})=>[h(T(ue(p.skuData,i.name)),1)]),_:2},1032,["prop","label"]))),128)),a(s,{prop:"productPrice",label:"原价",align:"center"}),N.value===1?(f(),D(s,{key:0,label:"拼团价",width:"150"},{default:u(({row:i,$index:p})=>[a(o,{label:"",prop:`grouponPromotionDetails.${p}.groupPromotionDetailPrices.0.price`,rules:[{required:!0,validator:O,trigger:"blur"}]},{default:u(()=>[a(H,{style:{width:"100px"},modelValue:i.groupPromotionDetailPrices[0].price,"onUpdate:modelValue":y=>i.groupPromotionDetailPrices[0].price=y},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop","rules"])]),_:1})):k("",!0),N.value===2?(f(!0),S(M,{key:1},F(l.value.length,(i,p)=>(f(),D(s,{key:p,label:`第${E.value[p]}阶梯`,width:"150"},{default:u(({row:y,$index:ve})=>[a(o,{label:"",prop:`grouponPromotionDetails.${ve}.groupPromotionDetailPrices.${p}.price`,rules:[{required:!0,validator:O}]},{default:u(()=>[a(H,{style:{width:"100px"},modelValue:y.groupPromotionDetailPrices[p].price,"onUpdate:modelValue":ge=>y.groupPromotionDetailPrices[p].price=ge},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop","rules"])]),_:2},1032,["label"]))),128)):k("",!0),a(s,{label:"可售数量",width:"100",prop:"limitNum",align:"center"},{header:u(()=>[a(v,{class:"box-item",effect:"dark",placement:"top","show-after":300},{content:u(()=>[...e[9]||(e[9]=[m("div",{style:{width:"200px",padding:"5px 10px"}}," 使用活动价可售的商品数量，超过设置的数量，仅可按原价购买 ",-1)])]),default:u(()=>[m("div",Ke,[e[10]||(e[10]=m("div",null,"可售数量",-1)),a(c,{style:{"margin-left":"5px"},size:"14",color:"#999"},{default:u(()=>[a(Q(De))]),_:1})])]),_:1})]),default:u(({row:i,$index:p})=>[a(o,{label:"",prop:`grouponPromotionDetails.${p}.limitNum`,rules:[{required:!0,validator:ne,trigger:"blur"}]},{default:u(()=>[a(n,{style:{width:"60px"},type:"integer",classType:"tig-form-input",modelValue:i.limitNum,"onUpdate:modelValue":y=>i.limitNum=y},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop","rules"])]),_:1}),a(s,{prop:"productStock",label:"商品库存",width:"100",align:"center"}),a(s,{prop:"isJoin",label:"是否参加",fixed:"right",align:"center"},{default:u(({row:i})=>[a(g,{modelValue:i.isJoin,"onUpdate:modelValue":p=>i.isJoin=p,"active-value":1,"inactive-value":0},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["data"])])]),_:1}),a(o,{class:"inner-item",label:"每单限购",prop:"orderLimitNum",required:""},{default:u(()=>[a(C,{modelValue:w.value,"onUpdate:modelValue":e[2]||(e[2]=i=>w.value=i),style:{width:"100%","margin-bottom":"10px","flex-direction":"column","align-items":"flex-start"},onChange:le},{default:u(()=>[a(I,{value:!1},{default:u(()=>[...e[11]||(e[11]=[h("不限购",-1)])]),_:1}),a(I,{value:!0},{default:u(()=>[m("div",qe,[e[13]||(e[13]=m("div",{class:"mr10"},"限购",-1)),a(n,{modelValue:t.value.orderLimitNum,"onUpdate:modelValue":e[1]||(e[1]=i=>t.value.orderLimitNum=i),disabled:!w.value,placeholder:"请输入限购数量",type:"integer",width:"200px"},{append:u(()=>[...e[12]||(e[12]=[h("件",-1)])]),_:1},8,["modelValue","disabled"])])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(o,{label:"自动成团",prop:"isAutoGroup"},{default:u(()=>[m("div",null,[a(Q(Ve),{modelValue:t.value.isAutoGroup,"onUpdate:modelValue":e[3]||(e[3]=i=>t.value.isAutoGroup=i)},{default:u(()=>[...e[14]||(e[14]=[h("开启",-1)])]),_:1},8,["modelValue"]),e[15]||(e[15]=m("div",{class:"desc"},"成团有效期结束时，达到最低成团人数，即可用匿名用户模拟成团",-1))])]),_:1}),t.value.isAutoGroup?(f(),D(o,{key:3,class:"inner-item",label:"成团最低人数",prop:"minGroupNum",rules:[{required:!0,validator:pe,trigger:"blur"}]},{default:u(()=>[m("div",null,[a(n,{decimalPlaces:3,class:"InputBox",placeholder:"请输入",type:"integer",modelValue:t.value.minGroupNum,"onUpdate:modelValue":e[4]||(e[4]=i=>t.value.minGroupNum=i),width:"200px",onBlur:ie},{append:u(()=>[...e[16]||(e[16]=[h("人",-1)])]),_:1},8,["modelValue"]),m("div",$e,"可填写1~"+T(x.value)+"成团人数之间的整数",1)])]),_:1},8,["rules"])):k("",!0),a(o,{label:"活动商品排序",prop:"sort"},{default:u(()=>[m("div",null,[a(n,{classType:"tig-form-input",type:"integer",width:"200px",modelValue:t.value.sort,"onUpdate:modelValue":e[5]||(e[5]=i=>t.value.sort=i)},null,8,["modelValue"]),e[17]||(e[17]=m("div",{class:"extra"},"序号越小，排名越前",-1))])]),_:1})]),_:1},8,["rules","model"]))])])])}}}),je=ke(Ce,[["__scopeId","data-v-a03837c0"]]);export{je as default};

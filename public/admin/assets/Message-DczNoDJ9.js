import{i as M,p as K,c as ue,_ as he,u as ye,r as ke}from"./format-BxqOrW-w.js";import{s as be,S as Ie,c as xe,d as Ce,a as ze,b as Te,e as we,f as Se}from"./SendMessage-4Jk2ijgH.js";import{d as ee,r as h,g as r,h as n,_ as te,aq as ve,x as Me,as as pe,ar as $e,aM as De,o as Ne,f as I,i as e,z as _,m as U,Q as H,l as v,F as $,k as j,p as X,j as m,t as g,q as Re,P as w,b as Be,Y as me,n as V,C as Ee,dt as Fe,s as J,an as _e}from"./index-B52YIGC0.js";import Ve from"./Reconnection-EqLGNFmK.js";/* empty css             *//* empty css                                                                    */import{P as je}from"./Pagination-C8J7-6Em.js";import{a as Ue}from"./product-hE35r0Q_.js";import Le from"./OrderImList-D13-nqzT.js";import{e as Oe}from"./Emoji-D1NIuMzg.js";import"./ReconnectionList-C2nCEauX.js";import"./StatusDot-DuKP0Xmc.js";import"./conversation-BgR-gwnn.js";import"./order-BVunCi_y.js";import"./index-KjhYqCTY.js";import"./index-C9ZdVeVx.js";import"./DialogForm.vue_vue_type_script_setup_true_lang-CT6mpwCc.js";const Pe=["innerHTML"],He=ee({__name:"emojiHtml",props:{content:{type:String,default:""}},setup(y){const R=y,D=h("");D.value=d(R.content,Oe);function d(b,p){const k=new RegExp(`(${p.map(i=>i.name).join("|")})`,"g");return b.replace(/\[|\]/g,"").replace(k,i=>{const l=p.find(x=>x.name===i);return l?"<img class='emoji' src='http://oss.tigshop.com/official/emoji/"+l.id+".png'>":i})}return(b,p)=>(n(),r("div",{innerHTML:D.value},null,8,Pe))}}),qe=te(He,[["__scopeId","data-v-7e152687"]]),Ae={class:"goods-search-container"},Ge={class:"goods-toolbar"},Ze={class:"goods-recommend-list"},Qe={class:"check-box"},We=["onClick"],Ye=["onClick"],Je={class:"name"},Ke={class:"price"},Xe={class:"goods-choosed-box"},et={key:0,class:"page"},tt={class:"bot"},st={key:0,class:"goods-choosed-box-left"},at={key:1,class:"goods-choosed-box-left-have"},nt={class:"im"},ot=["onClick"],rt=ee({__name:"SelectImProduct",props:ve({messageInfo:{type:Object,default:{}}},{linkSelectData:{type:Array,default:[]},linkSelectDataModifiers:{}}),emits:ve(["sendMessage"],["update:linkSelectData"]),setup(y,{emit:R}){const D=y,d=h(!0),b=h(0),p=Me(),k=h([]),i=pe({page:1,size:p.get("pageSize"),sortField:"",sortOrder:"",keyword:""});$e(y,"linkSelectData");const l=h([]),x=async()=>{d.value=!0;try{const c=await Ue({...i});k.value=c.records,k.value.forEach(s=>{s.check=l.value.some(f=>f.productId===s.productId)}),b.value=c.total}catch(c){w.error(c.message)}finally{d.value=!1}},N=c=>{const s=l.value.findIndex(f=>f.productId===c.productId);s!==-1?(l.value.splice(s,1),c.check=!1):l.value.length<3?(l.value.push(c),c.check=!0):w.error("一次最多发送三个商品")},B=c=>{if(c.check)N(c);else{const s=l.value.findIndex(f=>f.productId===c.productId);s!==-1&&l.value.splice(s,1)}},q=c=>{const s=l.value.splice(c,1)[0],f=k.value.findIndex(C=>C.productId===s.productId);f!==-1&&(k.value[f].check=!1)},S=()=>{L()},L=()=>{l.value.forEach(c=>{Z(c)})},A=De("receiveValueFromGrandChild"),G=R,Z=async c=>{try{let s={};Object.assign(s,D.messageInfo,{content:{messageType:"custom",product:c||""}});const f=await be(s);G("sendMessage",f),A(f),l.value=[],k.value.forEach(C=>C.check=!1)}catch(s){console.log(s)}finally{}};return Ne(()=>{x()}),(c,s)=>{const f=I("TigInput"),C=I("el-button"),Q=I("el-space"),E=I("el-checkbox"),F=I("el-image"),O=I("el-empty"),W=I("a-spin");return n(),r("div",Ae,[e("div",Ge,[_(Q,null,{default:U(()=>[_(f,{width:"190px",modelValue:i.keyword,"onUpdate:modelValue":s[0]||(s[0]=u=>i.keyword=u),placeholder:"商品名称/货号"},null,8,["modelValue"]),_(C,{onClick:x},{default:U(()=>[...s[3]||(s[3]=[H("搜索",-1)])]),_:1})]),_:1})]),e("div",Ze,[d.value?v("",!0):(n(),r($,{key:0},[b.value>0?(n(!0),r($,{key:0},X(k.value,u=>(n(),r("div",{key:u.productId,class:"product-item"},[e("div",Qe,[_(E,{modelValue:u.check,"onUpdate:modelValue":z=>u.check=z,onChange:z=>B(u)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),e("div",{class:"image-box",onClick:z=>N(u)},[_(F,{fit:"cover",class:"image",src:m(M)(u.picThumb)},null,8,["src"])],8,We),e("div",{class:"info-box",onClick:z=>N(u)},[e("div",Je,g(u.productName),1),e("div",Ke,g(m(K)(u.productPrice)),1)],8,Ye)]))),128)):(n(),j(O,{key:1,description:"暂无商品～"}))],64)),_(W,{spinning:d.value,style:{width:"100%","margin-top":"100px"}},null,8,["spinning"])]),e("div",Xe,[b.value>0?(n(),r("div",et,[_(m(je),{page:i.page,"onUpdate:page":s[1]||(s[1]=u=>i.page=u),size:i.size,"onUpdate:size":s[2]||(s[2]=u=>i.size=u),total:b.value,onCallback:x,layout:"slot, prev, next",background:!1},null,8,["page","size","total"])])):v("",!0),e("div",tt,[l.value.length===0?(n(),r("div",st,[...s[4]||(s[4]=[e("div",null,"尚未选择商品",-1)])])):(n(),r("div",at,[s[5]||(s[5]=e("div",null,"已选择",-1)),(n(!0),r($,null,X(l.value,(u,z)=>(n(),r("div",{class:"image-list",key:u.productId},[e("div",nt,[_(F,{fit:"cover",class:"lg-image",src:m(M)(u.picThumb)},null,8,["src"]),e("div",{class:"del-bb",onClick:Re(T=>q(z),["stop"])},null,8,ot)])]))),128))])),e("div",null,[_(C,{onClick:S,disabled:l.value.length===0,type:"primary"},{default:U(()=>[...s[6]||(s[6]=[H("确定",-1)])]),_:1},8,["disabled"])])])])])}}}),it=te(rt,[["__scopeId","data-v-4f4278b3"]]),lt={class:"im-center"},ct={class:"conversation-title-m_wrap_qcEBo"},dt={key:0,class:"conversation-title-m_name_1G8ZZ"},ut={class:"name"},vt={class:"flex"},mt={key:0,class:"reconnection"},_t={class:"message-list im-message-m_container_31cB1 im-message-box"},pt={class:"im-message-item__time"},gt={key:0,class:"im-message-item__username"},ft={class:"content__outer"},ht={class:"zent-avatar im-message-item__avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},yt=["src"],kt=["src"],bt={key:2,class:"zent-avatar-image",src:he},It={key:0,class:"im-message-item__content"},xt={key:0,class:"im-message-item__content-value"},Ct=["innerHTML"],zt={key:1,class:"im-message-item__content"},Tt={class:"im-message-item__content-value"},wt={key:2,class:"im-message-item__content"},St={key:0,class:"im-message-item__content-value im-message-item__content-card"},Mt=["href"],$t={class:"im-message-item__content-card-title"},Dt={class:"im-message-item__content-card-detail"},Nt={class:"im-message-item__content-card-figure"},Rt={class:"im-message-item__content-card-desc"},Bt={key:1,class:"im-message-item__content-card-link"},Et={class:"im-message-item__content-card-title"},Ft={class:"im-message-item__content-card-detail"},Vt={class:"im-message-item__content-card-figure"},jt={class:"right-info"},Ut={class:"im-message-item__content-card-order-name"},Lt={class:"im-message-item__content-card-order-info"},Ot={key:1},Pt={key:0,class:"im-message-item__read"},Ht={key:1,class:"im-message-item__unread"},qt={key:1},At={class:"im-message-item notice"},Gt={class:"im-message-item__content"},Zt={class:"im-edit-box"},Qt={key:0,class:"im-edit-box-mask"},Wt={class:"im-resizable im-right"},Yt={class:"zent-tabs zent-tabs-type__normal right-plugins-m_tabs_1oN_5"},Jt={class:"zent-tabs-nav zent-tabs-nav-type__normal"},Kt={class:"zent-tabs-nav-content"},Xt={class:"zent-tabs-scroll"},es={role:"tabpanel",class:"zent-tabs-panel thin-line"},ts={class:"profile-anonymous-m_line_kvakE",style:{height:"auto"}},ss={class:"zent-badge zent-badge--has-content conversation-list-item-avatar",style:{"margin-right":"16px"}},as={class:"zent-badge-content"},ns={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},os={class:"zent-avatar im-message-item__avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},rs=["src"],is=["src"],ls={class:"wechat-from"},cs={class:"name"},ds={class:"profile-anonymous-m_line_kvakE"},us={class:"profile-anonymous-m_line_kvakE"},vs={role:"tabpanel",class:"zent-tabs-panel"},ms={class:"profile-anonymous-m_line_kvakE",style:{height:"auto","flex-direction":"column","align-items":"flex-start"}},_s={class:"edit-input"},ps={class:"profile-anonymous-m_line_kvakE",style:{height:"auto","flex-direction":"column","align-items":"flex-start"}},gs={class:"edit-input"},fs={class:"action"},hs={key:1,class:"im-layout"},ys={class:"im-default-box"},ks={class:"im-default"},bs={class:"im-default-icon"},Is=ee({__name:"Message",props:{conversationId:{type:Number,default:""},currentNewMessage:{type:Object,default:()=>({})},currentConversationData:{type:Object,default:()=>({})},msgType:{type:Number,default:1},status:{type:Number,default:1},preview:{type:Boolean,default:!1}},emits:["update:conversationId","resumeConversation","_getConversationStrat"],setup(y,{expose:R,emit:D}){const d=y,b=h({}),p=h([]),k=h(!1),i=pe({conversationId:d.conversationId,sortOrder:"desc",firstId:-1}),l=h(null);let x=h(!0),N=h(0);const B=()=>{l.value&&(l.value.scrollTop=l.value.scrollHeight)},q=()=>{if(F(),l.value){x.value&&(N.value=l.value.scrollTop,x.value=!1);const{scrollTop:a,scrollHeight:o,clientHeight:P}=l.value;a==0&&k.value==!1&&p.value.length>0&&(i.firstId=p.value[0].id,c())}},S=D,L=a=>{p.value.push(a),J(()=>{B()})},A=Be(),G=()=>{_e.confirm("确认重新接入会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{xe({userId:d.currentConversationData.userId,userFrom:d.currentConversationData.userFrom}).then(a=>{d.preview?A.push({path:"/im/index",query:{id:a.id}}):(i.conversationId=a.id,i.firstId=-1,p.value=[],k.value=!1,c(),S("resumeConversation",!0))}).catch(a=>{w.error(a.message)})}).catch(()=>{})},Z=async()=>{_e.confirm("确认结束该会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{Ce({conversationId:i.conversationId}).then(a=>{s.value={},i.conversationId=-1,S("update:conversationId",-1),S("_getConversationStrat")}).catch(a=>{w.error(a.message)})})},c=async()=>{try{const a=await ze(i);if(a.records.length==0){k.value=!0;return}p.value=[...a.records,...p.value],J(()=>{i.firstId==-1?B():setTimeout(()=>{l.value&&(l.value.scrollTop=N.value,x.value=!0)},0)})}catch(a){console.error(a)}},s=h({}),f=async()=>{try{const a=await Se({conversationId:i.conversationId});s.value=a}catch(a){w.error(a.message),console.error(a)}},C=async()=>{try{const a=await Te({conversationId:s.value.id,remark:s.value.remark,summary:s.value.summary});w.success("保存成功")}catch(a){w.error(a.message)}};me(()=>d.conversationId,a=>{a&&a!=-1&&(i.conversationId=a,i.firstId=-1,p.value=[],k.value=!1,c(),f()),Object.keys(d.currentConversationData).length>0&&(b.value={conversationId:d.currentConversationData.id,userId:d.currentConversationData.userId,shopId:d.currentConversationData.shopId})},{immediate:!0,deep:!0});const Q=a=>p.value.findIndex(o=>o.id===a.id);me(()=>d.currentNewMessage,a=>{Object.keys(a).length>0&&Q(a)===-1&&(p.value.push(a),J(()=>{B()}))},{immediate:!0,deep:!0});const E=h(!1),F=()=>{d.currentConversationData.unreadMessageCount>0&&!E.value&&O(d.currentConversationData)},O=async a=>{try{E.value=!0;const o=await we({conversationId:a.id,userId:a.userId,shopId:a.shopId});d.currentConversationData.unreadMessageCount=0}catch(o){w.error(o.message)}finally{E.value=!1}},W=()=>{p.value.forEach(a=>{a.type===2&&a.isRead===0&&(a.isRead=1)})},u=a=>/\[(.*?)\]/g.test(a),z=()=>{S("update:conversationId",-1),S("_getConversationStrat")};R({_setRead:O,setReadOneself:W});const T=h(1),Y=a=>{T.value=a};return(a,o)=>{var ae,ne,oe,re,ie,le;const P=I("el-image"),se=I("TigInput"),ge=I("el-button"),fe=I("el-icon");return n(),r($,null,[i.conversationId!=-1?(n(),r("div",{key:0,class:V([y.preview?"preview-style":"","im-layout"]),onClick:F},[e("div",lt,[e("div",ct,[s.value.user?(n(),r("div",dt,[e("div",ut,g((ae=y.currentConversationData.user)==null?void 0:ae.username),1),e("div",vt,[y.preview?v("",!0):(n(),r("div",mt,[_(Ve,{onServersUpdated:z,conversationId:i.conversationId},null,8,["conversationId"])])),e("div",{class:"reception-panel-toolbar-waiting",onClick:Z},"结束")])])):v("",!0)]),e("div",_t,[e("div",{ref_key:"messageBoxRef",ref:l,onScroll:q,class:"message-list-content"},[(n(!0),r($,null,X(p.value,(t,xs)=>{var ce,de;return n(),r($,{key:t.id},[t.type!==3?(n(),r("div",{key:0,class:V(["im-message-item text",{left:t.type===1,right:t.type===2}])},[e("div",pt,g(t.sendTime),1),t.type===2&&t.servant?(n(),r("div",gt,g(t.servant.username),1)):v("",!0),e("div",ft,[e("span",ht,[t.type===2&&t.servant.avatar?(n(),r("img",{key:0,class:"zent-avatar-image",src:m(ue)(t.servant.avatar)},null,8,yt)):t.type===1&&t.user.avatar?(n(),r("img",{key:1,class:"zent-avatar-image",src:m(ue)(t.user.avatar)},null,8,kt)):(n(),r("img",bt))]),t.messageType=="text"?(n(),r("div",It,[t.content&&t.content.content?(n(),r("div",xt,[u(t.content.content)?(n(),j(m(qe),{key:1,content:t.content.content},null,8,["content"])):(n(),r("span",{key:0,innerHTML:t.content.content},null,8,Ct))])):v("",!0)])):v("",!0),t.content&&t.messageType=="image"?(n(),r("div",zt,[e("div",Tt,[_(P,{style:{height:"200px"},src:m(M)((ce=t.content)==null?void 0:ce.pic),"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[m(M)((de=t.content)==null?void 0:de.pic)],"hide-on-click-modal":"",fit:"cover"},null,8,["src","preview-src-list"])])])):v("",!0),t.messageType=="custom"?(n(),r("div",wt,[t.content?(n(),r("div",St,[t.content.product&&t.content.product!==null?(n(),r("a",{key:0,href:m(ye)({path:"product",sn:t.content.product.productSn}),target:"_blank",class:"im-message-item__content-card-link"},[e("h4",$t,g(t.content.product.productName),1),e("div",Dt,[e("figure",Nt,[_(P,{fit:"cover",width:"100%",style:{border:"1px solid #f5f5f5"},src:m(M)(t.content.product.picUrl?t.content.product.picUrl:t.content.product.picThumb)},null,8,["src"])]),e("p",Rt,g(m(K)(t.content.product.productPrice)),1)])],8,Mt)):v("",!0),t.content.order&&t.content.order!==null?(n(),r("a",Bt,[e("h4",Et,g(t.content.order.orderStatusName),1),e("div",Ft,[e("figure",Vt,[_(P,{fit:"cover",width:"100%",style:{border:"1px solid #f5f5f5"},src:m(M)(t.content.order.picUrl?t.content.order.picUrl:t.content.order.picThumb)},null,8,["src"])]),e("div",jt,[e("div",Ut,g(t.content.order.productName),1),e("div",Lt,[e("div",null,"共"+g(t.content.order.productNum)+"件商品",1),e("div",null,"合计"+g(m(K)(t.content.order.totalAmount)),1)])])])])):v("",!0)])):v("",!0)])):v("",!0)]),t.type===2?(n(),r("div",Ot,[t.isRead?(n(),r("span",Pt,"已读")):(n(),r("span",Ht,"未读"))])):v("",!0)],2)):v("",!0),t.type===3&&t.messageType==="text"?(n(),r("div",qt,[e("div",At,[e("div",Gt,g(t.sendTime)+" "+g(t.content?t.content.content:""),1)])])):v("",!0)],64)}),128))],544)]),e("div",Zt,[y.status===2?(n(),r("div",Qt,[o[6]||(o[6]=H(" 如需联系客户，请点击 ",-1)),e("a",{class:"zent-link",onClick:G},"开始对话")])):(n(),j(Ie,{key:1,messageInfo:b.value,onSendMessage:L},null,8,["messageInfo"]))])]),o[16]||(o[16]=e("div",{class:"im-resizable-anchor"},null,-1)),e("div",Wt,[e("div",Yt,[e("div",Jt,[e("div",Kt,[e("div",Xt,[e("div",{class:V(["zent-tabs-tab",{"zent-tabs-tab__actived":T.value==1}]),onClick:o[0]||(o[0]=t=>Y(1))},[...o[7]||(o[7]=[e("div",{class:"zent-tabs-tab-inner"},"资料",-1)])],2),e("div",{class:V(["zent-tabs-tab",{"zent-tabs-tab__actived":T.value==2}]),onClick:o[1]||(o[1]=t=>Y(2))},[...o[8]||(o[8]=[e("div",{class:"zent-tabs-tab-inner"},"订单",-1)])],2),y.preview?v("",!0):(n(),r("div",{key:0,class:V(["zent-tabs-tab",{"zent-tabs-tab__actived":T.value==3}]),onClick:o[2]||(o[2]=t=>Y(3))},[...o[9]||(o[9]=[e("div",{class:"zent-tabs-tab-inner"},"商品",-1)])],2))])])])]),e("div",null,[T.value==1?(n(),r($,{key:0},[e("div",es,[e("div",ts,[e("label",null,[e("div",ss,[e("div",as,[e("span",ns,[e("span",os,[m(Ee)(String((ne=s.value.user)==null?void 0:ne.avatar))=="def"?(n(),r("img",{key:0,class:"zent-avatar-image",src:m(ke)((oe=s.value.user)==null?void 0:oe.avatar)},null,8,rs)):(n(),r("img",{key:1,class:"zent-avatar-image",src:m(M)((re=s.value.user)==null?void 0:re.avatar)},null,8,is))])])])])]),e("div",ls,[e("div",cs,g((ie=s.value.user)==null?void 0:ie.username),1),o[10]||(o[10]=e("div",{class:"tags"},null,-1))])]),e("div",ds,[o[11]||(o[11]=e("label",null,"昵称：",-1)),e("span",null,g((le=s.value.user)==null?void 0:le.nickname),1)]),e("div",us,[o[12]||(o[12]=e("label",null,"会话来源：",-1)),e("span",null,g(s.value.userFrom),1)])]),e("div",vs,[e("div",ms,[o[13]||(o[13]=e("label",{style:{flex:"auto",margin:"8px 0 4px 0"}},"会话总结：",-1)),e("div",_s,[_(se,{modelValue:s.value.summary,"onUpdate:modelValue":o[3]||(o[3]=t=>s.value.summary=t)},null,8,["modelValue"])])]),e("div",ps,[o[14]||(o[14]=e("label",{style:{flex:"auto",margin:"8px 0 4px 0"}},"会话备注：",-1)),e("div",gs,[_(se,{modelValue:s.value.remark,"onUpdate:modelValue":o[4]||(o[4]=t=>s.value.remark=t),rows:6,type:"textarea"},null,8,["modelValue"])])]),e("div",fs,[_(ge,{type:"primary",disabled:s.value.remark=="",onClick:o[5]||(o[5]=t=>C())},{default:U(()=>[...o[15]||(o[15]=[H("保存",-1)])]),_:1},8,["disabled"])])])],64)):T.value==2?(n(),j(Le,{key:1,preview:y.preview,userId:y.currentConversationData.userId},null,8,["preview","userId"])):T.value==3?(n(),j(it,{key:2,messageInfo:b.value,onSendMessage:L},null,8,["messageInfo"])):v("",!0)])])],2)):v("",!0),i.conversationId==-1?(n(),r("div",hs,[e("div",ys,[e("div",ks,[e("div",bs,[_(fe,{color:"#d5d5d5",size:"50"},{default:U(()=>[_(m(Fe))]),_:1})]),o[17]||(o[17]=e("div",{class:"im-default-text"},[e("span",null,"没有选中会话哦")],-1))])])])):v("",!0)],64)}}}),Os=te(Is,[["__scopeId","data-v-900cac34"]]);export{Os as default};

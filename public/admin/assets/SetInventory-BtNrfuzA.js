import{d as B,r as p,f as r,g as Y,h as g,i as u,z as c,m as l,k as y,l as v,t as I,j,av as $,H as z,P as S,_ as F}from"./index-B52YIGC0.js";import{c as H,u as U}from"./inventoryCalendar-CGXkAm9Q.js";const E={class:"container"},O={class:"content_wrapper"},A={class:"table-header"},G={class:"input-wrapper"},J=B({__name:"SetInventory",props:{type:{type:String,default:"set"},productId:{type:Number,required:!0},shopId:{type:Number,required:!0},stockDate:{type:String,required:!0}},emits:["submitCallback","update:confirmLoading","close"],setup(i,{expose:D,emit:N}){const k=N,t=i,_=p(!0),f=p([]),T=p({productId:t==null?void 0:t.productId,shopId:t==null?void 0:t.shopId,stockDate:t==null?void 0:t.stockDate}),b=p({}),V=e=>{const n=new Date,a=z(n).format("YYYY-MM-DD"),s=n.getHours()*60+n.getMinutes();if(a===t.stockDate){const d=e.startTime.split(":"),m=e.endTime.split(":");parseInt(d[0])*60+parseInt(d[1]);const h=parseInt(m[0])*60+parseInt(m[1]);return s>=h}return!1},x=async()=>{_.value=!0;try{const e=await H({...T.value}),{timeSlotStockList:n,...a}=e;b.value=a,f.value=e.timeSlotStockList.map(s=>({...s,stockChange:0,usedStock:s.availableStock}))}catch(e){S.error(e.message)}finally{_.value=!1}},L=e=>{if(!(typeof e.stockChange=="string"&&e.stockChange==="-")){if(Number(e.stockChange)<0&&Math.abs(Number(e.stockChange))>Number(e.availableStock))return e.usedStock=0;e.usedStock=Number(e.availableStock)+Number(e.stockChange)}},q=async()=>{try{k("update:confirmLoading",!0),Object.assign(b.value,{timeSlotStockChanges:f.value.map(n=>{const{usedStock:a,...s}=n;return{...s,stockChange:Number(n.stockChange)}})});const e=await U(b.value);k("submitCallback",e),S.success("操作成功")}catch(e){S.error(e.message)}finally{k("update:confirmLoading",!1)}},M=()=>{q()};return x(),D({onFormSubmit:M}),(e,n)=>{const a=r("el-table-column"),s=r("el-icon"),d=r("el-tooltip"),m=r("TigInput"),h=r("el-table"),P=r("a-spin");return g(),Y("div",E,[u("div",O,[c(P,{spinning:_.value},{default:l(()=>[c(h,{data:f.value,border:"",align:"center"},{default:l(()=>[c(a,{label:"时间段",align:"center"},{default:l(({row:o})=>[u("span",null,I(`${o.startTime}~${o.endTime}`),1)]),_:1}),i.type==="edit"?(g(),y(a,{key:0,label:"当前可预约",prop:"availableStock",align:"center"})):v("",!0),c(a,{prop:"stockChange",align:"center"},{header:l(()=>[u("div",A,[u("span",null,I(i.type==="edit"?"增加/减少数量":"可预约数量"),1),i.type==="edit"?(g(),y(d,{key:0,effect:"dark",content:"正数为增加数量 负数为减少数量",placement:"top"},{default:l(()=>[c(s,null,{default:l(()=>[c(j($))]),_:1})]),_:1})):v("",!0)])]),default:l(({row:o})=>[u("div",G,[c(m,{width:"60px",classType:"tig-input",type:"integer",allowNegative:i.type==="edit",size:"medium",modelValue:o.stockChange,"onUpdate:modelValue":C=>o.stockChange=C,placeholder:"",disabled:V(o),onInput:C=>L(o)},null,8,["allowNegative","modelValue","onUpdate:modelValue","disabled","onInput"])])]),_:1}),i.type==="edit"?(g(),y(a,{key:1,align:"center",label:"实际可预约",prop:"usedStock"})):v("",!0)]),_:1},8,["data"])]),_:1},8,["spinning"])])])}}}),R=F(J,[["__scopeId","data-v-f40eb619"]]);export{R as default};

import{a4 as e,d as a,r as t,aM as l,aT as i,C as o,ay as r,F as s,c as u,b as c,i as n,w as v,e as d,I as p,a as f,$ as h,f as y,a0 as m,aL as b,k as g,Z as k,h as S,t as x,O as z,aP as w,aQ as _,bD as T,_ as C,bs as E,G as O,l as I,L as M,bE as $,R as j}from"./index-BZxHr1FI.js";import{_ as D,a as L}from"./tig-layout.DTz8E-sj.js";const N=C(a({__name:"VerifySlide",props:{captchaType:{type:String,default:"blockPuzzle"},imgSize:{type:Object,default:()=>({width:"310px",height:"155px"})},explain:{type:String,default:"向右拖动滑块填充拼图"},blockSize:{type:Object,default:()=>({width:50,height:50})},barSize:{type:Object,default:()=>({width:"310px",height:"40px"})},barMarginTop:{type:Number,default:8}},emits:["close","success"],setup(a,{expose:C,emit:E}){const O=a,I=E,M=t(!1),$=t(""),j=t(""),D=t(""),L=t(""),N=t(""),A=t(0),P=async()=>{try{const t=await(a={captchaType:O.captchaType},e({url:"common/verification/captcha",method:"POST",data:a}));$.value=t.originalImageBase64,j.value=t.jigsawImageBase64,D.value=t.token,L.value=t.secretKey}catch(t){console.error(t),N.value=t.message}var a},X=t(!1),q=t(""),F=t(""),J=t(""),Z=t(""),B=t("#ddd"),G=t("#d1e0f1"),R=t(""),V=t("icon-right"),K=t(!1),Q=t(!1),U=t(""),H=t(""),W=t(0),Y=t(""),ee=t({left:0,top:0,width:0,height:0}),ae=t(0),te=_(),le={active:{block:"#1991fa",border:"#1991fa",background:"#d1e0f1",icon:"#fff"},success:{block:"#52ccba",border:"#52ccba",background:"#d2f4ef",icon:"#fff"},error:{block:"#d9534f",border:"#d9534f",background:"#fce1e1",icon:"#fff"},default:{block:"#fff",border:"#ddd",background:"#d1e0f1",icon:"#666"}},ie=e=>{const a=le[e];Z.value=a.block,B.value=a.border,G.value=a.background,R.value=a.icon},oe=e=>{try{if(Q.value)return;const a=e.touches[0].clientX;W.value=Math.floor(a-ee.value.left),A.value=Date.now(),Y.value="",ie("active"),K.value=!0}catch(a){console.error("滑块验证初始化错误:",a)}},re=e=>{var a,t;try{if(!K.value||Q.value)return;const l=e.touches[0].clientX,i=(null==(a=ee.value)?void 0:a.left)||0,o=parseInt(O.blockSize.width)/2,r=((null==(t=ee.value)?void 0:t.width)||0)-o-2;let s=l-i;s=Math.max(o,Math.min(s,r));const u=s-W.value;F.value=`${u}px`,J.value=`${u+40}px`}catch(l){console.error("滑块移动处理错误:",l)}},se=()=>{try{if(ae.value=Date.now(),!K.value||Q.value)return;const e=ve();pe(e)}catch(e){console.error("滑块验证结束处理错误:",e),he()}},ue=e=>{try{if(Q.value)return;const a=e.clientX;W.value=Math.floor(a-ee.value.left),A.value=Date.now(),Y.value="",ie("active"),K.value=!0,document.addEventListener("mousemove",ce),document.addEventListener("mouseup",ne)}catch(a){console.error("滑块验证初始化错误:",a)}},ce=e=>{var a,t;try{if(!K.value||Q.value)return;const l=e.clientX,i=(null==(a=ee.value)?void 0:a.left)||0,o=parseInt(O.blockSize.width)/2,r=((null==(t=ee.value)?void 0:t.width)||0)-o-2;let s=l-i;s=Math.max(o,Math.min(s,r));const u=s-W.value;F.value=`${u}px`,J.value=`${u+40}px`}catch(l){console.error("滑块移动处理错误:",l)}},ne=()=>{try{if(document.removeEventListener("mousemove",ce),document.removeEventListener("mouseup",ne),ae.value=Date.now(),!K.value||Q.value)return;const e=ve();pe(e)}catch(e){console.error("滑块验证结束处理错误:",e),he()}},ve=()=>310*parseInt((F.value||"0").replace("px",""))/(parseInt(O.imgSize.width)||310),de=e=>{const a={x:e,y:5};return L.value?T(JSON.stringify(a),L.value):JSON.stringify(a)},pe=async a=>{try{const t={captchaType:O.captchaType,pointJson:de(a),token:D.value},l=await(a=>e({url:"common/verification/check",method:"POST",data:a}))(t);if(console.log("验证结果:",l),l.token){ie("success"),V.value="icon-check",X.value=!1,Q.value=!0,M.value=!0;const e=((ae.value-A.value)/1e3).toFixed(2);N.value=`${e}s验证成功`;const t={x:a,y:5},l=JSON.stringify(t),i=L.value?T(D.value+"---"+l,L.value):D.value+"---"+l;setTimeout(()=>{N.value="",I("close"),I("success",{verifyToken:i})},1e3)}else fe()}catch(t){console.error(t),fe()}finally{K.value=!1}},fe=()=>{ie("error"),V.value="icon-close",M.value=!1,setTimeout(()=>he(),1e3),N.value="验证失败",setTimeout(()=>{N.value=""},1e3)},he=()=>{X.value=!0,q.value="",U.value="left .3s",F.value="",J.value="",H.value="width .3s",ie("default"),V.value="icon-right",Q.value=!1,P(),setTimeout(()=>{H.value="",U.value="",Y.value=O.explain},300)};return l(()=>{P(),setTimeout(()=>{(async()=>{try{const e=await w(".verify-bar-area",te);e&&(ee.value=e)}catch(e){console.error(e)}})()},350)}),i(()=>{null==document||document.removeEventListener("mousemove",ce),null==document||document.removeEventListener("mouseup",ne)}),C({refresh:he}),(e,t)=>{const l=y,i=n,w=g,_=o(s("up-transition"),r);return c(),u(i,{class:"verifyslide"},{default:v(()=>[d(i,{class:"verify-img-out",style:p({height:parseInt(a.imgSize.height)+"px"})},{default:v(()=>[d(i,{class:"verify-img-panel",style:p({width:a.imgSize.width,height:a.imgSize.height})},{default:v(()=>[$.value?(c(),u(l,{key:0,src:"data:image/png;base64,"+$.value,class:"img"},null,8,["src"])):f("",!0),$.value?h((c(),u(i,{key:1,class:"verify-refresh",onClick:he},{default:v(()=>[b("i",{class:"iconfont-pc icon-refresh"})]),_:1},512)),[[m,X.value]]):f("",!0),d(_,{show:!!N.value,mode:"fade-up"},{default:v(()=>[d(w,{class:k("verify-tips "+(M.value?"suc-bg":"err-bg"))},{default:v(()=>[S(x(N.value),1)]),_:1},8,["class"])]),_:1},8,["show"])]),_:1},8,["style"])]),_:1},8,["style"]),d(i,{class:"verify-bar-area",style:p({width:a.imgSize.width,height:a.barSize.height,"line-height":a.barSize.height,marginTop:a.barMarginTop+"px"})},{default:v(()=>[d(w,{class:"verify-msg"},{default:v(()=>[S(x(Y.value),1)]),_:1}),d(i,{class:"verify-left-bar",style:p({width:void 0!==J.value?J.value:a.barSize.height,height:a.barSize.height,"border-color":B.value,"background-color":G.value,transition:H.value})},{default:v(()=>[d(w,{class:"verify-msg"},{default:v(()=>[S(x(Y.value),1)]),_:1}),d(i,{class:"verify-move-block",style:p({width:a.barSize.height,height:a.barSize.height,"background-color":Z.value,left:F.value,transition:U.value}),onTouchstart:oe,onTouchmove:z(re,["stop","prevent"]),onTouchend:se,onMousedown:ue},{default:v(()=>[b("i",{class:k(["verify-icon iconfont-pc",V.value]),style:p({color:R.value})},null,6),d(i,{class:"verify-sub-block",style:p({width:Math.floor(47*parseInt(a.imgSize.width)/310)+"px",height:a.imgSize.height,top:"-"+(parseInt(a.imgSize.height)+a.barMarginTop)+"px","background-size":a.imgSize.width+" "+a.imgSize.height})},{default:v(()=>[j.value?(c(),u(l,{key:0,src:"data:image/png;base64,"+j.value,class:"img"},null,8,["src"])):f("",!0)]),_:1},8,["style"])]),_:1},8,["style"])]),_:1},8,["style"])]),_:1},8,["style"])]),_:1})}}}),[["__scopeId","data-v-e4c2c813"]]),A=C(a({__name:"Verify",props:{captchaType:{type:String,required:!0},figure:{type:Number},arith:{type:Number},mode:{type:String,default:"pop"},vSpace:{type:Number},explain:{type:String},imgSize:{type:Object,default:()=>({width:"310px",height:"155px"})},blockSize:{type:Object},barSize:{type:Object},close:{type:Function}},emits:["okCallback"],setup(e,{expose:a,emit:l}){const i=e,{captchaType:r,figure:p,arith:h,mode:y,vSpace:m,explain:b,imgSize:g,blockSize:k,barSize:z}=E(i),w=t({}),_=l,T=t(!1),C=()=>{T.value=!1,w.value.refresh&&w.value.refresh()},I=e=>{_("okCallback",e)};return a({show:()=>{T.value=!0}}),(e,a)=>{const t=n,l=o(s("tig-popup"),D);return c(),u(l,{show:T.value,"onUpdate:show":a[0]||(a[0]=e=>T.value=e),"mask-click":!1,"custom-style":{width:O(g).width,"box-sizing":"content-box",padding:"10rpx 30rpx"},position:"center"},{default:v(()=>[d(t,{class:"content"},{default:v(()=>[d(t,{class:"title"},{default:v(()=>[S(x(e.$t("请完成安全验证")),1)]),_:1}),T.value?(c(),u(N,{key:0,ref_key:"instance",ref:w,"captcha-type":O(r),type:"2",figure:O(p),arith:O(h),mode:O(y),"v-space":O(m),explain:O(b),"img-size":O(g),"block-size":O(k),"bar-size":O(z),onClose:C,onSuccess:I},null,8,["captcha-type","figure","arith","mode","v-space","explain","img-size","block-size","bar-size"])):f("",!0)]),_:1})]),_:1},8,["show","custom-style"])}}}),[["__scopeId","data-v-fc76f1fe"]]),P=C(a({__name:"index",props:{email:{type:String,default:""},mobile:{type:String,default:""},requestApi:{type:Function,required:!0},isChecked:{type:Boolean,default:!1},verifyTokenData:{type:String,default:null},event:{type:String,default:"login"},btnType:{type:String,default:"button"}},emits:["mobileErrorCallback","update:isChecked","update:verifyTokenData"],setup(e,{emit:a}){const l=I(),{t:i}=M(),r=e,p=a,{mobile:h}=E(r),y=t(),m=t(""),b=t(!1),g=t(null),k=t(),z=()=>{b.value=!1},w=()=>{b.value=!0},_=async()=>{if(!1===r.isChecked)return p("mobileErrorCallback",i("请阅读并同意协议！"));if(!b.value){if(r.email){if(""==r.email)return void p("mobileErrorCallback",i("邮箱不能为空！"));if(!D(r.email))return void p("mobileErrorCallback",i("邮箱格式错误"))}else{if(""==h.value)return void p("mobileErrorCallback",i("手机号不能为空！"));if(!O(h.value))return void p("mobileErrorCallback",i("手机号格式错误"))}g.value?T():k.value.show()}},T=async()=>{try{await r.requestApi({mobile:h.value,email:r.email,verifyToken:g.value,event:r.event}),p("update:verifyTokenData",g.value),j({title:i("验证码已发送"),duration:1500}),y.value.canGetCode&&y.value.start()}catch(e){p("mobileErrorCallback",e.message),p("update:verifyTokenData","")}finally{g.value=null}},C=e=>{m.value=e},O=e=>!!(l.isOpenMobileAreaCode?/^[1-9]\d{10,14}$/:/^(?:(?:\+|00)86)?1\d{10}$/).test(e),D=e=>/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(e),N=e=>{g.value=e.verifyToken,_()};return(a,t)=>{const l=o(s("tig-button"),L),i=n,r=o(s("up-code"),$);return c(),u(i,{class:"box"},{default:v(()=>["button"===e.btnType?(c(),u(l,{key:0,plain:!0,disabled:b.value,class:"btn-verify",onClick:_},{default:v(()=>[S(x(m.value),1)]),_:1},8,["disabled"])):f("",!0),"text"===e.btnType?(c(),u(i,{key:1,plain:!0,disabled:b.value,class:"verify-btn",onClick:_},{default:v(()=>[S(x(m.value),1)]),_:1},8,["disabled"])):f("",!0),d(r,{ref_key:"uCodeRef",ref:y,seconds:60,"start-text":a.$t("获取验证码"),"end-text":a.$t("重新获取"),"change-text":a.$t("X秒重新获取"),onEnd:z,onStart:w,onChange:C},null,8,["start-text","end-text","change-text"]),d(A,{ref_key:"verifyRef",ref:k,mode:"pop","captcha-type":"blockPuzzle","img-size":{width:"310px",height:"155px"},onOkCallback:N},null,512)]),_:1})}}}),[["__scopeId","data-v-f9c461b2"]]);export{P as V,A as a};
